<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
	<title>我的发布 10,14,44,52</title>
	<!--css-->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/command.css">
	<link rel="stylesheet" href="css/loader.css">
	<link rel="stylesheet" href="css/animate.css">
	<link rel="stylesheet" href="css/search.css">
	<link rel="stylesheet" href="css/myPublish.css">
	<style>
		.nav > li > a:hover{
			background-color:rgba(31,154,218,0.7);
		}
		.navbar-toggle .icon-bar {
			background-color: #fff;
		}
		.navbar-nav > li > a:focus{
			background:none;
		}
	</style>
	<!--js-->
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/jquery.cookie.js"></script>
	<script src="js/ngUrl.js"></script>
	<script src="js/login.js"></script>
	<script src="js/base64.js"></script>
	<script src="js/md5.js"></script>
	<script>
		$(function() {
			//加载页面头尾登陆
			$("a").focus(function(){this.blur()});
			$("header").load("common/header.html");
			$("footer").load("common/footer.html");
			$("#loginTem").load("common/login.html");
			$(window).load(function(){
				$(".be-loader").fadeOut("slow");
			});
			var reps;
			//请求所有rep
			$.ajax({
				url: ngUrl+"/repositories",
				type: "get",
				cache:false,
				data:{},
				async:false,
				dataType:'json',
				headers:{ Authorization:"Token "+$.cookie("token") },
				success:function(json){
					if(json.code == 0){
						reps = json.data;
					}
				},
				error:function(json){
					alert(json.msg);
				}
			});
			//请求每个rep的详情
			for(var i in reps) {
				var rep = reps[i];
				$.ajax({
					url: ngUrl+"/repositories/"+rep.repname,
					type: "get",
					cache:false,
					data:{items:1},
					async:false,
					dataType:'json',
					headers:{ Authorization:"Token "+$.cookie("token") },
					success:function(json){
						if(json.code == 0){
							for(var j in json.data) {
								rep[j] = json.data[j];
							}
						}
					},
					error:function(json){
						alert(json.msg);
					}
				});
				//获取star量
				$.ajax({
					url: ngUrl+"/star_stat/"+rep.repname,
					type: "get",
					cache:false,
					data:{},
					async:false,
					dataType:'json',
					success:function(json){
						if(json.code == 0){
							rep["numstars"] = json.data.numstars;
						}
					},
					error:function(json){
						alert(json.msg);
					}
				});
				//获取订阅量
				$.ajax({
					url: ngUrl+"/subscription_stat/"+rep.repname,
					type: "get",
					cache:false,
					data:{},
					async:false,
					dataType:'json',
					success:function(json){
						if(json.code == 0){
							rep["numsubs"] = json.data.numsubs;
						}
					},
					error:function(json){
						alert(json.msg);
					}
				});
				//获取下载量
				$.ajax({
					url: ngUrl+"/transaction_stat/"+rep.repname,
					type: "get",
					cache:false,
					data:{},
					async:false,
					dataType:'json',
					success:function(json){
						if(json.code == 0){
							rep["numpulls"] = json.data.numpulls;
						}
					},
					error:function(json){
						alert(json.msg);
					}
				});
			}
			writeDom();
			//折叠筐：显示和隐藏每个rep的item列表
			$("#publish-body .repolist .describe").click(function () {
				//获取仓库名
				var repname = $(this).find(".head .head-text a:first").text();
				//请求item详情
				var rep = getRep(reps, repname);
				//没有item就不请求，直接返回，也不折叠items列表
				if(rep.items == 0 || rep.dataitems == undefined) {
					rep.dataitems = [];
					return;
				}
				//如果没有请求过dataitems就请求，已经请求过就跳过
				if(rep.dataitems.length > 0 && rep.dataitems[0].name == undefined ) {
					for (var j in rep.dataitems) {
						var item = rep.dataitems[j];
						$.ajax({
							url: ngUrl + "/repositories/" + rep.repname + "/" + item,
							type: "get",
							cache: false,
							data: {items: 1},
							async: false,
							dataType: 'json',
							headers: {Authorization: "Token " + $.cookie("token")},
							success: function (json) {
								if (json.code == 0) {
									rep.dataitems[j] = json.data;
								}
							},
							error: function (json) {
								alert(json.msg);
							}
						});
						rep.dataitems[j]["name"] = item;
					}
				}
				if($(this).next(".tablelist").length == 0) {
					//创建tablelist
					var tablelist = $("<div></div>").addClass("tablelist").css("display", "none").appendTo($(this).parent());
					var dtable = $("<div></div>").addClass("dtable").appendTo(tablelist);
					var dhead = $("<div></div>").addClass("dhead").appendTo(dtable);
					dhead.append($("<span><b>DateItem name</b></span>").addClass("col1"));
					dhead.append($("<span><b>更新时间</b></span>").addClass("col2"));
					dhead.append($("<span><b>属性</b></span>").addClass("col3"));
					dhead.append($("<span><b>Tag数量</b></span>").addClass("col4"));
					var dbody = $("<div></div>").addClass("dbody").appendTo(dtable);
					for(var i in rep.dataitems) {
						var item = rep.dataitems[i];
						var row = $("<div></div>").addClass("row").appendTo(dbody);
						row.append($("<span></span>").addClass("col1").text(item.name));
						var showtime = item.optime.substring(item.optime.indexOf("|")+1,item.optime.length);
						var titletime = item.optime.substring(0,item.optime.indexOf("."));
						row.append($("<span></span>").addClass("col2").text(showtime).attr("title", titletime));
						row.append($("<span></span>").addClass("col3").text(item.itemaccesstype == "private" ? "私有":"公有"));
						row.append($("<span></span>").addClass("col4").text(item.tags));
					}
					var dtail = $("<div></div>").addClass("dtail").appendTo(dtable);
					var icons = $("<span></span>").appendTo(dtail);
					icons.append($("<span></span>").addClass("icon1"));
					icons.append($("<span></span>").addClass("icon2"));
				}
				//动画
				var o = $(this).closest(".describe").next();
				o.toggle("fast");//垂直加水平动画
			});
			//把数据写入页面
			function writeDom() {
				//写仓库数量
				$("#publish-body .repocount span").text(reps.length);
				//写rep列表
				for(var i in reps) {
					var rep = reps[i];
					//创建reporecord
					var reporecord = $("<div></div>").addClass("reporecord").appendTo($("#publish-body .repolist"));
					//创建describe，并追加到reporecord
					var describe = $("<div></div>").addClass("describe").appendTo(reporecord);
					//创建head并追加到describe
					var head = $("<div></div>").addClass("head").appendTo(describe);
					head.append($("<span></span>").addClass("head-text").append($("<a></a>").attr("href", "repDetails.html?repname="+rep.repname).text(rep.repname)));
					head.append($("<span></span>").addClass("head-icon1"));
					head.append($("<span></span>").addClass("head-icon2"));
					//创建body，并追加到describe
					var body = $("<div></div>").addClass("body").text(rep.comment).appendTo(describe);
					//创建tail并追加到describe
					var tail = $("<div></div>").addClass("tail").appendTo(describe);
					//创建左侧icon并追加到tail
					var left = $("<span></span>").addClass("left").appendTo(tail);
					left.append($("<span></span>").addClass("left1-icon icon").attr("title", "更新时间"));
					var showtime = rep.optime.substring(rep.optime.indexOf("|")+1,rep.optime.length);
					var titletime = rep.optime.substring(0,rep.optime.indexOf("."));
					left.append($("<span></span>").addClass("left1-value val").text(showtime).attr("title", titletime));
					left.append($("<span></span>").addClass("left2-icon icon").attr("title", "属性"));
					left.append($("<span></span>").addClass("left2-value val").text(rep.repaccesstype == "private" ? "私有":"公有"));
					left.append($("<span></span>").addClass("left3-icon icon").attr("title", "托管状态"));
					left.append($("<span></span>").addClass("left3-value val").text("非托管"));/*TODO 需要托管状态，暂时没有获取到*/
					left.append($("<span></span>").addClass("left4-icon icon").attr("title", "DataItem"));
					left.append($("<span></span>").addClass("left4-value val").text(rep.items));
					//创建右侧icon并追加到tail
					var right = $("<span></span>").addClass("right").appendTo(tail);
					right.append($("<span></span>").addClass("right1-icon icon").attr("title", "star量"));
					right.append($("<span></span>").addClass("right1-value val").text(rep.numstars));
					right.append($("<span></span>").addClass("right2-icon icon").attr("title", "订阅量"));
					right.append($("<span></span>").addClass("right2-value val").text(rep.numsubs));
					right.append($("<span></span>").addClass("right2-icon icon").attr("title", "pull量"));
					right.append($("<span></span>").addClass("right2-value val").text(rep.numpulls));
				}
			}
		});
		function getRep(reps,repname) {
			for(var i in reps) {
				if(reps[i].repname == repname) {
					return reps[i];
				}
			}
		}
	</script>
</head>
<body>
<div class="be-loader" style="display: block;">
	<div class="spinner">
		<div class="spinner-container container1">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
		<div class="spinner-container container2">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
		<div class="spinner-container container3">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
	</div>
</div>
<header></header>

<div id="publish" class="container">
	<div id="publish-head">
		<span class="name"><b>我的发布</b></span>
		<span class="add-icon"></span>
	</div>
	<div id="publish-body">
		<div class="repocount">
			Repository:<span></span>
		</div>
		<div class="repolist">
		</div>
	</div>
</div>
<footer></footer>
<div id="loginTem"></div>
</body>
</html>