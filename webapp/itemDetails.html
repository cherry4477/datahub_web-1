<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>dataHub-Item详情</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/command.css">
	<link rel="stylesheet" href="css/loader.css">
	<link rel="stylesheet" href="css/animate.css">
	<link rel="stylesheet" href="css/search.css">
	<link rel="stylesheet" href="css/pagination.css">
	<link rel="stylesheet" href="css/itemDetails.css">
	<link rel="stylesheet" href="css/editormd.css">

</head>

<style>
	.nav > li > a:hover{
		background-color:rgba(31,154,218,0.7);
	}
	.navbar-toggle .icon-bar {
		background-color: #fff;
	}
	.navbar-nav > li > a:focus{
		background:none;
	}
</style>

<body>
<div class="be-loader" style="display: block;">
	<div class="spinner">
		<div class="spinner-container container1">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
		<div class="spinner-container container2">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
		<div class="spinner-container container3">
			<div class="circle1"></div>
			<div class="circle2"></div>
			<div class="circle3"></div>
			<div class="circle4"></div>
		</div>
	</div>
</div>
<header></header>
<div id="dataitem" class="container">
	<div id="dataitem-right">
		<div id="introduce1">
			<div class="introduce1-head">关于<span></span></div>
			<div class="introduce1-body"></div>
		</div>
		<div id="introduce2">
			<div class="introduce2-a">
				<span class="a-icon" title="更新时间"></span>
				<span class="a-value"></span>
			</div>
			<div class="introduce2-b">
				<span class="filetype"></span>
			</div>
			<div class="introduce2-c">
				<div class="rep">
					<div class="name">所属Repository</div>
					<div class="value"><div></div><a href="#"></a></div>
				</div>
				<div class="owner">
					<div class="name">数据拥有方</div>
					<div class="value"><div></div><a href="#"></a></div>
				</div>
			</div>
		</div>
		<div id="introduce3">
			<div class="introduce3-icon"></div>
			<div class="introduce3-text"><a href="clientDownload.html">Client端下载</a></div>
		</div>
		<!--<div id="introduce4">
			<div class="introduce4-head">
				<b>相关DataItem</b>
			</div>
			<div class="introduce4-body">
				<div>
					<div class="num">1</div>
					<div class="name">DataItem Name</div>
					<div class="icons">
						<span class="star-icon"></span>
						<span class="star-value">238</span>
						<span class="subscript-icon"></span>
						<span class="subscript-value">344</span>
						<span class="downloaded-icon"></span>
						<span class="downloaded-value">235</span>
					</div>
				</div>
			</div>
		</div>-->
	</div>
	<div id="dataitem-left">
		<div id="dataitem-head">
			<div id="dataitem-head-left" style="text-align: left;float: left;">
				<span class="icon"></span>
				<span class="repname"><a></a></span>
				<span class="line">&nbsp;/&nbsp;</span>
				<span class="itemname"></span>
			</div>
			<div id="dataitem-head-right" style="text-align: right;float: right;">
				<span class="star">
					<span class="icon"  title="star量">
						<span class="icon-image gray_star"></span
						><span class="icon-text">Star</span>
					</span
					><span class="value"></span>
				</span
				><span class="subscript">
					<span class="icon" title="订购量">
						<span class="icon-image"></span
						><span class="icon-text">订购</span>
					</span
					><span class="value"></span>
				</span
				><span class="downloaded">
					<span class="icon" title="pull量"></span
					><span class="value"></span>
				</span>
			</div>
		</div>
		<div id="dataitem-body">
			<div id="dataitem-tag">
				<div class="tag-head">
					<span class="icon" title="tag量"></span>
					<span class="text"></span>
				</div>
				<div class="tag-body">
					<div id="show-message" style="display: none">
						<span class="login">您还没有登录，请<a>登录</a></span>
					</div>
					<table></table>
					<div id="splitpage"></div>
				</div>
			</div>

			<div id="dataitem-exemple">
				<div class="exemple-head">
					<span class="text">样例</span>
				</div>
				<div class="exemple-body markdown-body"></div>
			</div>
			<div id="dataitem-metadata">
				<div class="metadata-head">
					<span class="text">元数据</span>
				</div>
				<div class="metadata-body markdown-body"></div>
			</div>
		</div>
	</div>
</div>
<div id="authority-dialog">
	<div class="up">
		<span class="icon">&nbsp;</span
		><span class="text">余额权限不足</span>
	</div>
	<div class="down">
		<span>请发邮件至</span
		><span class="email"></span
		><span>申请订阅权限。</span>
	</div>
</div>
<footer></footer>
<div id="loginTem"></div>
</body>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.cookie.js"></script>
<script src="js/ngUrl.js"></script>
<script src="js/login.js"></script>
<script src="js/base64.js"></script>
<script src="js/md5.js"></script>
<script src="js/jquery.zclip.js"></script>
<script src="js/jquery.pagination.js"></script>
<script src='js/marked.js'></script>
<script src='js/clipboard.min.js'></script>
<script>
	var login = false;
	var firsttry = true;
	var tags = 0;
	$("a").focus(function(){this.blur()});
	$("header").load("common/header.html");
	$("footer").load("common/footer.html");
	$("#loginTem").load("common/login.html");
	$(window).load(function(){
		$(".be-loader").fadeOut("slow");
	});
	$(window).load(function(){
		$("#dataitem-tag #show-message a").click(function() {
			$(".modal-open").css("padding-right","15px");
			$('#myModal').modal('toggle');
		});
		$(document).bind('click',function(e){
			if(e.target.id != "show-message" && e.target.id != "authority-dialog") {
				$('#show-message').hide();
				$("#authority-dialog").hide();
			}
		});
		$('#dataitem-tag .tag-body .tag-5 .btn').click(function(e){
			stopEventStrans(e);
		});
		$("#dataitem-head-right .star .icon").click(function(e) {
			stopEventStrans(e);
			if(!login) {
				var off = $(this).closest("#dataitem-head-right").offset();
				$("#show-message")
					.css({position: "absolute",'top':off.top+30,'left':off.left})
					.show();
				return;
			}else {
				var repname = getParam("repname");
				var itemname = getParam("itemname");
				var authorization = login ? {Authorization:"Token "+$.cookie("token")}:"";
				//查看是否公开
				var access;
				var create_user;
				$.ajax({
					url: ngUrl+"/repositories/"+repname+"/"+itemname,
					type: "get",
					cache:false,
					data:{},
					async:false,
					dataType:'json',
					success:function(json){
						if(json.code == 0){
							access = json.data.itemaccesstype;
							create_user = json.data.create_user;
						}
					},
					error:function(json){
						alert(json.msg);
					}
				});
				if(access !=  "public") {
					$("#authority-dialog .down .email").text(create_user);
					var off = $(this).closest("#dataitem-head-right").offset();
					$("#authority-dialog")
						.css({'top':off.top+30,'left':off.left-100})
						.show();
					return;
				}
				//查看是否点过赞
				var starred = false;
				$.ajax({
					url: ngUrl+"/star/"+repname+"/"+itemname,
					type: "GET",
					cache:false,
					data:{},
					async:false,
					dataType:'json',
					headers:authorization,
					success:function(json){
						if(json.code == 0){
							starred = json.data.starred
						}
					},
					error:function(json){
						alert(JSON.stringify(JSON.parse(json.responseText)));
					}
				});
				if(starred) {
					$.ajax({
						url: ngUrl+"/star/"+repname+"/"+itemname+"?star=0",
						type: "PUT",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						headers:authorization,
						success:function(json){
							if(json.code == 0){
								var stars = parseInt($("#dataitem-head-right .star .value").text());
								$("#dataitem-head-right .star .value").text(stars-1);
								$("#dataitem-head-right .star .icon .icon-image").removeClass("red_star");
								$("#dataitem-head-right .star .icon .icon-image").addClass("gray_star");
							}
						},
						error:function(json){
							alert(JSON.stringify(JSON.parse(json.responseText)));
						}
					});
				}else {
					$.ajax({
						url: ngUrl+"/star/"+repname+"/"+itemname+"?star=1",
						type: "PUT",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						headers:authorization,
						success:function(json){
							if(json.code == 0){
								var stars = parseInt($("#dataitem-head-right .star .value").text());
								$("#dataitem-head-right .star .value").text(stars+1);
								$("#dataitem-head-right .star .icon .icon-image").removeClass("gray_star");
								$("#dataitem-head-right .star .icon .icon-image").addClass("red_star");
							}
						},
						error:function(json){
							alert(JSON.stringify(JSON.parse(json.responseText)));
						}
					});
				}
			}
		});
		$("#dataitem-head-right .subscript .icon").click(function(e) {
			stopEventStrans(e);
			if(!login) {
				var off = $(this).closest("#dataitem-head-right").offset();
				$("#show-message")
					.css({position: "absolute",'top':off.top+30,'left':off.left})
					.show();
				return;
			}else {
				var repname = getParam("repname");
				var itemname = getParam("itemname");
				var create_user;
				var subscripted;
				$.ajax({
					url: ngUrl+"/repositories/"+repname+"/"+itemname,
					type: "get",
					cache:false,
					data:{},
					async:false,
					dataType:'json',
					success:function(json){
						if(json.code == 0){
							subscripted = json.data.itemaccesstype;
							create_user = json.data.create_user;
						}
					},
					error:function(json){
						alert(json.msg);
					}
				});
				if(subscripted == "private") {
					$("#authority-dialog .down .email").text(create_user);
					var off = $(this).closest("#dataitem-head-right").offset();
					$("#authority-dialog")
						.css({'top':off.top+30,'left':off.left-100})
						.show();
					return;
				}
			}
		});
		$("#authority-dialog").click(function(e) {
			stopEventStrans(e);
		});
	});

	$(document).ready(function(){
		if($.cookie("token")!=null&&$.cookie("tname")!=null&&$.cookie("tname")!="null"&&$.cookie("tname")!="null"){
			login = true;
		}
		ajaxRe();
		$("#splitpage").pagination(tags, {
			callback: ajaxRe,//PageCallback() 为翻页调用次函数。
			prev_text: " 上一页",
			next_text: "下一页 ",
			items_per_page: 6, //每页的数据个数
			num_display_entries: 1, //两侧首尾分页条目数
			num_edge_entries: 3, //连续分页主体部分分页条目数
			current_page: 0,   //当前页码
			ellipse_text:"...",
			link_to:"javascript:void(0)"
		});
	});


	function ajaxRe(index){
		var repname = getParam("repname");
		var itemname = getParam("itemname");
		var header = login ? {Authorization:"Token "+$.cookie("token")}:"";
		if(firsttry) {
			index = 0;
		}
		$.ajax({
			url: ngUrl+"/repositories/"+repname+"/"+itemname+"?page="+(index+1)+"&size=6",
			type: "get",
			cache:false,
			data:{},
			async:false,
			dataType:'json',
			success:function(json){
				if(json.code == 0){
					//获取tags
					tags = json.data.tags;
					if(firsttry) {
						firsttry = false;
						return;
					}
					//设置repname
					$("#dataitem-head-left .repname a").text(repname).attr("href", "repDetails.html?repname="+repname);
					$("#dataitem-head-left .itemname").text(itemname);
					//设置点赞量、订阅量、下载量
					if(login) {
						$.ajax({//初始化点赞
							url: ngUrl+"/star/"+repname+"/"+itemname,
							type: "GET",
							cache:false,
							data:{},
							async:false,
							dataType:'json',
							headers:header,
							success:function(json){
								if(json.code == 0){
									var starred = json.data.starred;
									if(starred) {
										$("#dataitem-head-right .star .icon .icon-image").removeClass("gray_star");
										$("#dataitem-head-right .star .icon .icon-image").addClass("red_star");
									}
								}
							},
							error:function(json){
								alert(JSON.stringify(JSON.parse(json.responseText)));
							}
						});
					}
					$.ajax({
						url: ngUrl+"/star_stat/"+repname+"/"+itemname,
						type: "get",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						success:function(json){
							if(json.code == 0){
								$("#dataitem-head-right .star .value").text(json.data.numstars);
							}
						},
						error:function(json){
							alert(json.msg);
						}
					});
					$.ajax({
						url: ngUrl+"/subscription_stat/"+repname+"/"+itemname,
						type: "get",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						success:function(json){
							if(json.code == 0){
								$("#dataitem-head-right .subscript .value").text(json.data.numsubs);
							}
						},
						error:function(json){
							alert(json.msg);
						}
					});
					$.ajax({
						url: ngUrl+"/transaction_stat/"+repname+"/"+itemname,
						type: "get",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						success:function(json){
							if(json.code == 0){
								$("#dataitem-head-right .downloaded .value").text(json.data.numpulls);
							}
						},
						error:function(json){
							alert(json.msg);
						}
					});
					//设置tag数量
					$("#dataitem-tag .tag-head .text").text(json.data.tags);
					//设置tag详情，先清空table
					$("#dataitem-tag .tag-body table").html("");
					for(var i=0; i<json.data.taglist.length; i++) {
						var tag = json.data.taglist[i];
						var td1 = $("<td></td>").addClass("tag-1").text(tag.tag);
						var td2 = $("<td></td>").addClass("tag-2").text(tag.comment);
						var tagtime=tag.optime;
						var atagtime = tagtime.substring(tagtime.indexOf("|")+1,tagtime.length);
						var btagtime = tagtime.substring(0, tagtime.indexOf(".") > -1 ? tagtime.indexOf(".") : tagtime.indexOf("|"));
						var td3 = $("<td></td>").addClass("tag-3").text(atagtime).attr("title",btagtime);
						var td4 = $("<td></td>").addClass("tag-4").css("position", "relative");
						td4.append($("<input>").addClass("plaintext").attr("type", "text").attr("id", "clipval_"+i).attr("readonly", "readonly").attr("value", repname+"/"+itemname+":"+tag.tag));
						var clipbtn = $("<input>").addClass("btn").attr("type", "button").attr("data-clipboard-action","copy").attr("data-clipboard-target", "#clipval_"+i).attr("value", "复制");
						var clipboard = new Clipboard(clipbtn.get(0));
						clipboard.on('success', function(e) {
							alert("复制成功!");
						});
						clipboard.on('error', function(e) {
							alert("暂不支持此浏览器,请手动复制或更换浏览器!");
						});
						td4.append(clipbtn);
						var td5btn = $("<input>").addClass("btn").attr("type", "button").attr("value", "Pull");
						td5btn.click(function(e) {
							var off = $(this).offset();
							var dailog = $("#show-message");
							dailog.css({position: "absolute",'top':off.top+25,'left':off.left-110}).show();
							stopEventStrans(e);
						});
						var td5 = $("<td></td>").addClass("tag-5").append(td5btn);
						var td5div = $("<div></div>").addClass("download").css("font-size", "0px").appendTo(td5);
						var divicon = $("<span></span>").addClass("icon").appendTo(td5div).attr("title", "pull量");
						//设置tag下载量
						var numpulls = -1;
						var nummypulls = -1;
						$.ajax({
							url: ngUrl+"/transaction_stat/"+repname+"/"+itemname+"/"+tag.tag,
							type: "get",
							cache:false,
							data:{},
							async:false,
							dataType:'json',
							headers:header,
							success:function(json){
								if(json.code == 0){
									numpulls = json.data.numpulls;
									nummypulls = json.data.nummypulls;
								}
							},
							error:function(json){
								alert(json.msg);
							}
						});
						var divtext = $("<span></span>").addClass("text").text(numpulls).appendTo(td5div);
						var tr = $("<tr></tr>").append(td1).append(td3).append(td4).append(td5);
						$("#dataitem-tag .tag-body table").append(tr);
						if(json.data.label.sys.supply_style == "batch") {
							td2.insertAfter(td1);
						}
						//已登录
						if(login) {
							$("<td></td>").addClass("numPulls").insertBefore(td4).text("pull:"+nummypulls);
							$("#show-message .login").hide();
							$("#show-message .tag").remove();
							$("<span><!--<a href=''>-->请下载Client端<!--</a>--></span>").addClass("tag").appendTo($("#show-message"));
						}
					}
					//设置样例和元数据
					$("#dataitem-exemple .exemple-body").html(marked(json.data.Sample));
					$("#dataitem-metadata .metadata-body").html(marked(json.data.Meta));
					//设置introduce1的itemname
					$("#introduce1 .introduce1-head span:first").attr("title", itemname).text(itemname);
					//设置comment
					$("#introduce1 .introduce1-body").text(json.data.comment);
					//设置时间
					var time=json.data.optime;
					var atime = time.substring(0, time.indexOf(".") > -1 ? time.indexOf(".") : time.indexOf("|"));
					var btime = time.substring(time.indexOf("|")+1,time.length);
					$("#introduce2 .introduce2-a .a-value").attr("title",atime).text(btime);
					//设置标签
					if(json.data.label.sys.supply_style == "flow") {
						$("#introduce2 .introduce2-b .filetype").css("background-color", "#fc9b00").text("流式数据");
					}else if(json.data.label.sys.supply_style == "batch") {
						$("#introduce2 .introduce2-b .filetype").css("background-color", "#20abe2").text("批量数据");
					}else if(json.data.label.sys.supply_style == "single") {
						$("#introduce2 .introduce2-b .filetype").css("background-color", "#f06f77").text("API");
					}
					var ptags = json.data.label.owner;
					for(var i in ptags) {
						$("<span></span>").addClass("personaltag").css("background-color", "#6ecbcc").text(ptags[i]).appendTo("#introduce2 .introduce2-b");
					}

					//设置仓库和数据拥有方
					$("#introduce2 .introduce2-c .rep a").attr("title", repname).text(repname).attr("href", "repDetails.html?repname="+repname);
					var createuser = json.data.create_user;
					$.ajax({
						url: ngUrl+"/users/"+createuser,
						type: "get",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						success:function(json){
							if(json.code == 0){
								var owner = json.data.userName || json.data.nickName;
								$("#introduce2 .introduce2-c .owner a").attr("title", owner).text(owner).attr("href", "dataOfDetails.html?username="+createuser);
							}
						},
						error:function(json){
							alert(json.msg);
						}
					});
				}else {
					console.log("报错");
				}
			},
			error:function(json){
				alert(json.msg);
			}
		});
		$("body,html").animate({scrollTop:0},0);
	}
	function getParam(key) {
		var value='';
		var itemid = new RegExp("\\?.*"+key+"=([^&]*).*$");
		if (itemid.test(decodeURIComponent(window.location.href))) {
			value = itemid.exec(decodeURIComponent(window.location.href))[1];
		}
		return value;
	}
	function stopEventStrans(e) {
		e = e || window.event;
		if (e.stopPropagation) {
			e.stopPropagation();//IE以外
		} else {
			e.cancelBubble = true;//IE
		}
	}
</script>
</html>