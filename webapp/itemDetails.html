<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>dataHub-搜索</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/command.css">
	<link rel="stylesheet" href="css/loader.css">
	<link rel="stylesheet" href="css/animate.css">
	<link rel="stylesheet" href="css/search.css">
	<link rel="stylesheet" href="css/itemDetails.css">
</head>

<style>
	.nav > li > a:hover{
		background-color:rgba(31,154,218,0.7);
	}
	.navbar-toggle .icon-bar {
		background-color: #fff;
	}
	.navbar-nav > li > a:focus{
		background:none;
	}
</style>

<body>
	<div class="be-loader" style="display: block;">
		<div class="spinner">
			<div class="spinner-container container1">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container2">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container3">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
		</div>
	</div>
	<header></header>
	<div id="dataitem" class="container-fluid">
		<div id="dataitem-right">
			<div id="introduce1">
				<div class="introduce1-head">关于<span></span></div>
				<div class="introduce1-body"></div>
			</div>
			<div id="introduce2">
				<div class="introduce2-a">
					<span class="a-icon" title="更新时间"></span>
					<span class="a-value"></span>
				</div>
				<div class="introduce2-b">
					<span class="filetype"></span>
				</div>
				<div class="introduce2-c">
						<div class="row rep">
							<div class="col-xs-5">所属Repository</div>
							<div class="col-xs-7"><div></div><a href="#"></a></div>
						</div>
						<div class="row owner">
							<div class="col-xs-5">数据拥有方</div>
							<div class="col-xs-7"><div></div><a href="#"></a></div>
						</div>
				</div>
			</div>
			<!--<div id="introduce3">
				<div class="introduce3-icon"></div>
				<div class="introduce3-text"><a>Client端下载</a></div>
			</div>
			<div id="introduce4">
				<div class="introduce4-head">
					<b>相关DataItem</b>
				</div>
				<div class="introduce4-body">
					<div>
						<div class="num">1</div>
						<div class="name">DataItem Name</div>
						<div class="icons">
							<span class="star-icon"></span>
							<span class="star-value">238</span>
							<span class="subscript-icon"></span>
							<span class="subscript-value">344</span>
							<span class="downloaded-icon"></span>
							<span class="downloaded-value">235</span>
						</div>
					</div>
				</div>
			</div>-->
		</div>
		<div id="dataitem-left">
			<div id="dataitem-head">
				<div id="dataitem-head-left" style="text-align: left;float: left;">
					<span class="icon"></span>
					<span class="repname"><a></a></span>
					<span>&nbsp;/&nbsp;</span>
					<span class="itemname"><b></b></span>
				</div>
				<div id="dataitem-head-right" style="text-align: right;float: right;">
					<span class="star-icon icon" title="star量"></span>
					<span class="star-value value"></span>
					<span class="subscript-icon icon" title="订阅量"></span>
					<span class="subscript-value value"></span>
					<span class="downloaded-icon icon" title="pull量"></span>
					<span class="downloaded-value value"></span>
				</div>
			</div>
			<div id="dataitem-body">
				<div id="dataitem-tag">
					<div class="tab-head">
						<div class="tab-head-div">Tag:<span></span></div>
						<div class="tab-head-icon"></div>
					</div>
					<div class="tag-body">
						<div id="show-message" style="display: none">
							<span class="login">您还没有登录，请<a>登录</a></span>
						</div>
						<table></table>
					</div>
				</div>

				<div id="dataitem-exemple">
					<div class="tab-head">
						<div class="tab-head-div">样例</div>
						<div class="tab-head-icon"></div>
					</div>
					<div class="exemple-body"></div>
				</div>
				<div id="dataitem-metadata">
					<div class="tab-head">
						<div class="tab-head-div">元数据</div>
						<div class="tab-head-icon"></div>
					</div>
					<div class="metadata-body"></div>
				</div>
			</div>
		</div>
	</div>
	<footer></footer>
	<div id="loginTem"></div>
</body>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.cookie.js"></script>
<script src="js/ngUrl.js"></script>
<script src="js/login.js"></script>
<script src="js/base64.js"></script>
<script src="js/md5.js"></script>
<script src="js/jquery.zclip.js"></script>
<script>
	var login = false;
	$("a").focus(function(){this.blur()});
	$("header").load("common/header.html");
	$("footer").load("common/footer.html");
	$("#loginTem").load("common/login.html");
	$(window).load(function(){
		$(".be-loader").fadeOut("slow");
	});
	$(window).load(function(){
		$("#dataitem-tag .tag-body .tag-4 .btn").zclip({
			path:'js/ZeroClipboard.swf',
			copy:function() {
				return $(this).parent().children(".plaintext:first").val();
			},
			afterCopy:function() {
				alert("复制成功");
			},
		});
		$("#dataitem-tag .tag-body .tag-5 .btn").click(function() {
			var off = $(this).offset();
			var dailog = $("#show-message");
			dailog.css({position: "absolute",'top':off.top+25,'left':off.left-110});
			dailog.css("display", "block");
		});
		$("#dataitem-tag #show-message a").click(function() {
			$(".modal-open").css("padding-right","15px");
			$('#myModal').modal('toggle');
		});
		function stopPropagation(e) {
			if (e.stopPropagation)
				e.stopPropagation();
			else
				e.cancelBubble = true;
		}
		$(document).bind('click',function(e){
			if(e.target.id != "show-message") {
				$('#show-message').css('display','none');
			}
		});
		$('#dataitem-tag .tag-body .tag-5 .btn').click(function(e){
			stopPropagation(e);
		});
	});

	$(document).ready(function(){
		if($.cookie("token")!=null&&$.cookie("tname")!=null&&$.cookie("tname")!="null"&&$.cookie("tname")!="null"){
			login = true;
		}
		ajaxRe();
	});


	function ajaxRe(){
		var repname = getParam("repname");
		var itemname = getParam("itemname");
		$.ajax({
			url: ngUrl+"/repositories/"+repname+"/"+itemname,
			type: "get",
			cache:false,
			data:{},
			async:false,
			dataType:'json',
			success:function(json){
				if(json.code == 0){
					//设置repname
					$("#dataitem-head-left .repname a").text(repname).attr("href", "repDetails.html?repname="+repname);
					$("#dataitem-head-left .itemname b").text(itemname);
					//设置点赞量、订阅量、下载量
					$("#dataitem-head-right .star-value").text(json.data.stars);
					$.ajax({
						url: ngUrl+"/subscription_stat/"+repname+"/"+itemname,
						type: "get",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						success:function(json){
							if(json.code == 0){
								$("#dataitem-head-right .subscript-value").text(json.data.numsubs);
							}
						},
						error:function(json){
							alert(json.msg);
						}
					});
					$.ajax({
						url: ngUrl+"/transaction_stat/"+repname+"/"+itemname,
						type: "get",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						success:function(json){
							if(json.code == 0){
								$("#dataitem-head-right .downloaded-value").text(json.data.numpulls);
							}
						},
						error:function(json){
							alert(json.msg);
						}
					});
					//设置tag数量
					$("#dataitem-tag .tab-head .tab-head-div>span").text(json.data.tags);
					//设置tag详情
					for(var i=0; i<json.data.taglist.length; i++) {
						var tag = json.data.taglist[i];
						var td1 = $("<td></td>").addClass("tag-1").text(tag.tag);
						var td2 = $("<td></td>").addClass("tag-2").text(tag.comment);
						var tagtime=tag.optime;
						var atagtime = tagtime.substring(tagtime.indexOf("|")+1,tagtime.length);
						var btagtime = tagtime.substring(0, tagtime.indexOf("."));
						var td3 = $("<td></td>").addClass("tag-3").text(atagtime).attr("title",btagtime);
						var td4 = $("<td></td>").addClass("tag-4").css("position", "relative");
						td4.append($("<input>").addClass("plaintext").attr("type", "text").attr("value", "/"+repname+"/"+itemname+":"+tag.tag));
//						td4.append($("<input>").addClass("btn").attr("type", "button").attr("value", "复制"));
						var td5 = $("<td></td>").addClass("tag-5").append($("<input>").addClass("btn").attr("type", "button").attr("value", "Pull"));
						var td5div = $("<div></div>").addClass("download").css("font-size", "0px").appendTo(td5);
						var divicon = $("<span></span>").addClass("icon").appendTo(td5div).attr("title", "pull量");
						//设置tag下载量
						var numpulls = -1;
						var nummypulls = -1;
						var header = login ? {Authorization:"Token "+$.cookie("token")}:"";
						$.ajax({
							url: ngUrl+"/transaction_stat/"+repname+"/"+itemname+"/"+tag.tag,
							type: "get",
							cache:false,
							data:{},
							async:false,
							dataType:'json',
							headers:header,
							success:function(json){
								if(json.code == 0){
									numpulls = json.data.numpulls;
									nummypulls = json.data.nummypulls;
								}
							},
							error:function(json){
								alert(json.msg);
							}
						});
						var divtext = $("<span></span>").addClass("text").text(numpulls).appendTo(td5div);
						var tr = $("<tr></tr>").append(td1).append(td3).append(td4).append(td5);
						$("#dataitem-tag .tag-body table").append(tr);
						if(json.data.label.sys.supply_style == "batch") {
							td2.insertAfter(td1);
						}
						//已登录
						if(login) {
							$("<td></td>").addClass("numPulls").insertBefore(td4).text("pull:"+nummypulls);
							td5.children(".btn:first").click(function() {

								$("#show-message .login").hide();
								$("#show-message .tag").remove();
								$("<span><!--<a href=''>-->请下载客户端<!--</a>--></span>").addClass("tag").appendTo($("#show-message"));
							});
						}
					}
					//设置样例和元数据
					$("#dataitem-exemple .exemple-body").html(json.data.Sample.replace(/\n/g, "<br/>"));
					$("#dataitem-metadata .metadata-body").html(json.data.Meta.replace(/\n/g, "<br/>"));
					//设置introduce1的itemname
					$("#introduce1 .introduce1-head span:first").attr("title", itemname).text(itemname);
					//设置comment
					$("#introduce1 .introduce1-body").text(json.data.comment);
					//设置时间
					var time=json.data.optime;
					var atime = time.substring(0, time.indexOf("."));
					var btime = time.substring(time.indexOf("|")+1,time.length);
					$("#introduce2 .introduce2-a .a-value").attr("title",atime).text(btime);
					//设置标签
					if(json.data.label.sys.supply_style == "flow") {
						$("#introduce2 .introduce2-b .filetype").css("background-color", "#fc9b00").text("流式数据");
					}else if(json.data.label.sys.supply_style == "batch") {
						$("#introduce2 .introduce2-b .filetype").css("background-color", "#20abe2").text("批量数据");
					}else if(json.data.label.sys.supply_style == "single") {
						$("#introduce2 .introduce2-b .filetype").css("background-color", "#f06f77").text("API");
					}
					var ptags = json.data.label.owner;
					for(var i in ptags) {
						$("<span></span>").addClass("personaltag").css("background-color", "#6ecbcc").text(ptags[i]).appendTo("#introduce2 .introduce2-b");
					}

					//设置仓库和数据拥有方
					$("#introduce2 .introduce2-c .rep a").attr("title", repname).text(repname).attr("href", "repDetails.html?repname="+repname);
					var createuser = json.data.create_user;
					$.ajax({
						url: ngUrl+"/users/"+createuser,
						type: "get",
						cache:false,
						data:{},
						async:false,
						dataType:'json',
						success:function(json){
							if(json.code == 0){
								var owner = json.data.userName || json.data.nickName;
								$("#introduce2 .introduce2-c .owner a").attr("title", owner).text(owner).attr("href", "dataOfDetails.html?username="+createuser);
							}
						},
						error:function(json){
							alert(json.msg);
						}
					});
				}else {
					console.log("报错");
				}
			},
			error:function(json){
				alert(json.msg);
			}
		});
	}
	function getParam(key) {
		var value='';
		var itemid = new RegExp("\\?.*"+key+"=([^&]*).*$");
		if (itemid.test(decodeURIComponent(window.location.href))) {
			value = itemid.exec(decodeURIComponent(window.location.href))[1];
		}
		return value;
	}
</script>
</html>