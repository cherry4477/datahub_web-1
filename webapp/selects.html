<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>datahub-数据精选</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/command.css">
<link rel="stylesheet" href="css/loader.css">
<link rel="stylesheet" href="css/animate.css">
<link rel="stylesheet" href="css/selects.css">

</head>

<style>
	.nav > li > a:hover{
		background-color:rgba(31,154,218,0.7); 
	}	
	.navbar-toggle .icon-bar {
	    background-color: #fff;
	}
	.navbar-nav > li > a:focus{
		background:none;
	}
</style>

<body>


	<div class="be-loader" style="display: block;">
	   	<div class="spinner">
			<div class="spinner-container container1">
				<div class="circle1"></div>
			    <div class="circle2"></div>
			    <div class="circle3"></div>
			    <div class="circle4"></div>
			</div>
		  	<div class="spinner-container container2">
			    <div class="circle1"></div>
			    <div class="circle2"></div>
			    <div class="circle3"></div>
			    <div class="circle4"></div>
		  	</div>
		  	<div class="spinner-container container3">
			    <div class="circle1"></div>
			    <div class="circle2"></div>
			    <div class="circle3"></div>
			    <div class="circle4"></div>
			</div>
		</div>
	</div>
	
	
	<!-- 头部导航 -->
	<header></header>
	
	<!-- 内容页 -->
	<div class="container-fluid" style='padding:0px;margin-top:50px;'>

			<div id="navigator" class="col-md-2 col-sm-2 navigator-background" style="padding: 20px 20px;position: absolute;height:100%;"><!--TODO-->
					<div id="navigator-name"><b>精选导航</b></div>
					<ul id="navigator-ul">
					</ul>
			</div>
			
			<div class="col-md-10 col-sm-10" id="lComs">			
				<!-- 适配 -->
				<div id="navigator10" class="col-md-10 col-sm-10 navigator-background" ><!--TODO-->
					<div id="navigator-name"><b>精选导航</b></div>
					<ul id="navigator-ul10">
					</ul>
				</div>
				<div id="terminal-content-head"><b id="allJ">全部精选</b></div>
				<div id="terminal-content-body"></div>	
			</div>		
		
	</div>
	
	
	
	<!-- 尾部 -->
	<footer></footer>
	
	<div id="loginTem"></div>
	


</body>

<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.cookie.js"></script>
<script src="js/ngUrl.js"></script>
<script src="js/login.js"></script>
<script src="js/base64.js"></script>
<script src="js/md5.js"></script>
<script>

	$("a").focus(function(){this.blur()});
	$("header").load("common/header.html");
	$("footer").load("common/footer.html");
	$("#loginTem").load("common/login.html");
	
	var repos=[];
	
	$(window).load(function(){
		$(".be-loader").fadeOut("slow");
	});

	$(document).ready(function(){
		$.ajax({
			url: ngUrl+"/select_labels",
    		type: "get",
    		cache:false,
    	   	async:false,
    		dataType:'json',
    		success:function(json){  
    			if(json.data.length!=0){
    				var pages=json.data.length;
    				for(var i=0;i<pages;i++){
    					$("#navigator-ul").append("<li>"+json.data[i].labelname+"</li>");	
    					$("#navigator-ul10").append("<li>"+json.data[i].labelname+"</li>");
    				}
    			}else{
    				
    			}
				console.log("测试数据："+json.data.length);  			
    		},
    		error:function(json){
    			alert("程序出错，请稍后重试");
    		}
    	});
		
		ajaxRe();
		
		
		
		$("body").on("click","#navigator-ul li",function(){
			$("#terminal-content-body").empty();
			$("#terminal-content-body").append("<div class='container-fluid' id='loading'><p class='text-center'>正在加载请稍后...</p></div>");
			repos.length = 0;//数据清空
			
			$(this).siblings().css("border","1px solid #ccc").css("color","#666");
			$(this).siblings().removeClass("overs");
			if($(this).hasClass("overs")){
				$(this).removeClass("overs");
				$(this).css("border","1px solid #ccc").css("color","#666");
				$("#allJ").text("全部精选");
				ajaxRe();
			}else{
				$(this).addClass("overs");
				$(this).css("border","1px solid #29abe2").css("color","#29abe2");
				$("#allJ").text($(this).text()+"精选");
				$.ajax({
					url: ngUrl+"/selects?select_labels=%22"+$(this).text()+"%22",
		    		type: "get",
		    		cache:false,
		    	   	async:false,
		    		dataType:'json',
		    		success:function(json){  	    			
		    			if(json.data.length!=0){
		    				var pages=json.data.length;
		    				for(var i=0;i<pages;i++){
		    					repos.push([json.data[i].repname,json.data[i].itemname]);			
		    				}
		    			}else{
		    				console.log("报错");  			
		    			}	    		
		    		},
		    		error:function(json){
		    			alert("程序出错，请稍后重试");
		    		}
		    	});
				
				//返回该DataItem的订阅量
		        var dataitemd = [];
		        for(var i= 0;i<repos.length;i++) {
		            $.ajax({
		                url: ngUrl + "/subscription_stat/" +repos[i][0],
		                cache: false,
		                async: false,
		                success: function (msg) {
		                    dataitemd.push(msg.data.numsubs);
		                }
		            });
		        }
		        //返回该DataItem的pull量
		        var dataitemdpullNum = [];
		        for(var i= 0;i<repos.length;i++) {
		            $.ajax({
		                url: ngUrl + "/transaction_stat/" +repos[i][0]+repos[i][1],
		                cache: false,
		                async: false,
		                success: function (msg) {
		                    dataitemdpullNum.push(msg.data.numpulls);
		                }
		            });
		        }
		        
				
				for(var i=0;i<repos.length;i++){
					$.ajax({
						url: ngUrl+"/repositories/"+repos[i][0]+"/"+repos[i][1],
			    		type: "get",
			    		cache:false,
			    	   	async:false,
			    		dataType:'json',
			    		success:function(json){ 
			    			$("#loading").empty();
		    					var vvclass="";
		    					var label=json.data.label.sys.supply_style;
		    					var labelV="";
			    				if(label="single"){
			    					vvclass="period";
			    					labelV="实时单条";
			    				}
			    				if(label="batch"){
			    					vvclass="api";
			    					labelV="批量数据";
			    				}
			    				if(label="flow"){
			    					vvclass="charge";
			    					labelV="流式数据";
			    				}
			    				
			    				var times=json.data.optime;
			    				var jdTime="";
			    				var xdTime="";
			    				var showTime="";
			    				var nums=times.indexOf("|");
			    				if(nums!="-1"){
			    					jdTime=times.substring(0,nums+1);
			    					xdTime=times.substring(nums+1,times.length);
			    					showTime=xdTime;
			    				}else{
			    					showTime=times;
			    				}
			    						    				
			    				
		    					$("#terminal-content-body").append(""+
				    					"<div>"+
											"<div class='repo-head'>"+
												"<div class='repo-head-left'><a style='color:#fff' href='repDetails.html?repname="+repos[i][0]+"'>"+repos[i][0]+"</a>/<a style='color:#fff' href='itemDetails.html?repname="+repos[i][0]+"&itemname="+repos[i][1]+"'>"+repos[i][1]+"</a></div>"+
												"<div class='repo-head-right'>数据拥有方：<a href='dataOfDetails.html?username="+json.data.create_user+"'>"+json.data.create_user+"</a></div>"+	
											"</div>"+
											"<div class='repo-body'>"+
												"<div id='repo-text'>"+json.data.comment+"</div>"+
												"<div class='repo-body-tail'>"+
													"<div class='repo-body-tail-left'>"+
														"<div class='updatetime-icon'></div>"+
														"<div class='updatetime-value' title="+jdTime+">"+showTime+"</div>"+
														"<div class='tag-icon' title='tag数量'></div>"+
														"<div class='tag-value'>"+json.data.tags+"</div>"+
													"</div>"+
													"<div class='repo-body-tail-mid'>"+
														"<div class="+vvclass+">"+labelV+"</div>"+
				    								"</div>"+
													"<div class='repo-body-tail-right'>"+
														"<div class='shwr'>"+
															"<div class='star-icon' title='star量'></div>"+
															"<div class='star-value'>"+json.data.stars+"</div>"+
															"<div class='subscript-icon' title='订阅量'></div>"+
		    				                                "<div class='subscript-value'>"+dataitemd[i]+"</div>"+
		    				                                "<div class='downloaded-icon' title='pull量'></div>"+
		    				                                "<div class='downloaded-value'>"+dataitemdpullNum[i]+"</div>"+
				    				                        "</div>"+
													"</div>"+
												"</div>"+
											"</div>"+
										"</div>"
				    				);	    		
			    		},
			    		error:function(json){
			    			alert("程序出错，请稍后重试");
			    		}
		    		}); 
				}
				
				
				
				
			}
			


			
		});
		
		
	});
	
	
	function ajaxRe(){
		$.ajax({
			url: ngUrl+"/selects?select_labels",
    		type: "get",
    		cache:false,
    	   	async:false,
    		dataType:'json',
    		success:function(json){  	    			
    			if(json.data.length!=0){
    				var pages=json.data.length;
    				for(var i=0;i<pages;i++){
    					repos.push([json.data[i].repname,json.data[i].itemname]);			
    				}
    			}else{
    				console.log("报错");  			
    			}	    		
    		},
    		error:function(json){
    			alert("程序出错了，请稍后重试");
    		}
    	});
		
		//返回该DataItem的订阅量
        var dataitemd = [];
        for(var i= 0;i<repos.length;i++) {
            $.ajax({
                url: ngUrl + "/subscription_stat/" +repos[i][0],
                cache: false,
                async: false,
                success: function (msg) {
                    dataitemd.push(msg.data.numsubs);
                }
            });
        }
        //返回该DataItem的pull量
        var dataitemdpullNum = [];
        for(var i= 0;i<repos.length;i++) {
            $.ajax({
                url: ngUrl + "/transaction_stat/" +repos[i][0]+repos[i][1],
                cache: false,
                async: false,
                success: function (msg) {
                    dataitemdpullNum.push(msg.data.numpulls);
                }
            });
        }

		for(var i=0;i<repos.length;i++){
			$.ajax({
				url: ngUrl+"/repositories/"+repos[i][0]+"/"+repos[i][1],
	    		type: "get",
	    		cache:false,
	    	   	async:false,
	    		dataType:'json',
	    		success:function(json){ 
	    			$("#loading").empty();
    				var vvclass="";
    					var label=json.data.label.sys.supply_style;
    					if(label="single"){
	    					vvclass="period";
	    					labelV="实时单条";
	    				}
	    				if(label="batch"){
	    					vvclass="api";
	    					labelV="批量数据";
	    				}
	    				if(label="flow"){
	    					vvclass="charge";
	    					labelV="流式数据";
	    				}
	    				
	    				var times=json.data.optime;
	    				var jdTime="";
	    				var xdTime="";
	    				var showTime="";
	    				var nums=times.indexOf("|");
	    				if(nums!="-1"){
	    					jdTime=times.substring(0,nums+1);
	    					xdTime=times.substring(nums+1,times.length);
	    					showTime=xdTime;
	    				}else{
	    					showTime=times;
	    				}
	    				
    					$("#terminal-content-body").append(""+
		    					"<div>"+
									"<div class='repo-head'>"+
										"<div class='repo-head-left'><a style='color:#fff' href='repDetails.html?repname="+repos[i][0]+"'>"+repos[i][0]+"</a>/<a style='color:#fff' href='itemDetails.html?repname="+repos[i][0]+"&itemname="+repos[i][1]+"'>"+repos[i][1]+"</a></div>"+
										"<div class='repo-head-right'>数据拥有方：<a href='dataOfDetails.html?username="+json.data.create_user+"'>"+json.data.create_user+"</a></div>"+	
									"</div>"+
									"<div class='repo-body'>"+
										"<div id='repo-text'>"+json.data.comment+"</div>"+
										"<div class='repo-body-tail'>"+
											"<div class='repo-body-tail-left'>"+
												"<div class='updatetime-icon'></div>"+
												"<div class='updatetime-value' title="+jdTime+">"+showTime+"</div>"+
												"<div class='tag-icon' title='tag数量'></div>"+
												"<div class='tag-value'>"+json.data.tags+"</div>"+
											"</div>"+
											"<div class='repo-body-tail-mid'>"+
												"<div class="+vvclass+">"+labelV+"</div>"+
		    								"</div>"+
											"<div class='repo-body-tail-right'>"+
												"<div class='shwr'>"+
												"<div class='star-icon' title='star量'></div>"+
												"<div class='star-value'>"+json.data.stars+"</div>"+
												"<div class='subscript-icon' title='订阅量'></div>"+
				                                "<div class='subscript-value'>"+dataitemd[i]+"</div>"+
				                                "<div class='downloaded-icon' title='pull量'></div>"+
				                                "<div class='downloaded-value'>"+dataitemdpullNum[i]+"</div>"+
		    				                        "</div>"+
											"</div>"+
										"</div>"+
									"</div>"+
								"</div>"
		    				);	    		
	    		},
	    		error:function(json){
	    			alert("程序出错，请稍后重试");
	    		}
    		}); 
		}
	}
	
	
	
	
	
	
	
	
	
	
</script>
</html>
